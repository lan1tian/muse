# 调度设计
本文档是关于调度设计方面的，包括了调度阶段定义，调度时间与触发时间，调度依赖，调度计划，任务重跑等内容。


## 调度阶段与执行阶段
* 调度与执行是先后发生的两个阶段；任务是先调度，后执行。
* 调度：依赖任务都调度了，则开始调度后续任务。
* 执行：依赖任务都执行，且成功了，则开始执行后续任务。
* 调度没有成功的概念，只有是否结束。执行有成功失败的概念。
* 理论上，假定所有任务执行时间为0，执行成功的情况下，调度结束时间就是执行开始时间。


## 调度时间与触发时间
#### 调度时间：
* 任务开始调度：意味任何一个依赖任务开始触发。
* 计算公式：依赖任务触发时间的最小值。（时间触发时，指时间触发时刻）

#### 触发时间：
* 任务结束调度：意味所有依赖任务都触发了，即满足调度的依赖条件。
* 计算公式：依赖任务触发时间的最大值。（时间触发时，指时间触发时刻）
![schedule_time](http://gitlab.mogujie.org/bigdata/jarvis2/raw/master/docs/design/img/schedule_time.png)


## 调度依赖
调度依赖包括“依赖策略“与“依赖区间”

#### 调度依赖策略
当依赖job在调度区间内有多个Task时，需要指定依赖策略。

* All：调度区间内，所有依赖满足。
* Any：调度区间内，任何1个依赖满足。
* First（n）：调度区间内，前面n个依赖满足。
* Last（n）：调度区间内，后面n个依赖满足。
* Continuous（n）：连续n个依赖满足。


#### 调度依赖区间
定义调度依赖的区间，通过基准时间与偏移时间来计算。

* 表达式 = ( 基准时间 t ，起始偏移时间 x(n), 结束偏移时间 x(m)] 
  * 例子：("yyyy-MM-dd HH:00:00", x(n), x(m)]
  * 基准时间 t ：基准时间的格式化，默认"yyyy-MM-dd HH:mm:ss"
  * 起始偏移时间 x(n)："基准时间"向前偏移x(n)时间，作为偏移时间的起始点。（正数向前，负数向后）
  * 结束偏移时间 x(m)：偏移开始时间 向前偏移x(m)时间，作为偏移时间的结束点。（正数向前，负数向后） 
  * 时间单位：年y、月M、周w、天d、时h、分m、秒s
![schedule_time](http://gitlab.mogujie.org/bigdata/jarvis2/raw/master/docs/design/img/dependency_scope.png)

* 简化版配置
  * **cd**      当天。 对应表达式 （yyyy-MM-dd 00:00:00, d(-1), d(1) ]
  * **d(n)**    前 n 天 。 对应表达式 （yyyy-MM-dd 00:00:00, d(0), d(n) ]
  * **d(n,m)**  前 n 至 n+m 天 。 对应表达式 （yyyy-MM-dd 00:00:00, d(n), d(m) ]
  * 其他时间单位的表示以此类推

## 调度计划

#### 调度计划生成
* **动态生成**，根据计划开始时间与计划结束时间，动态生成。
* **生成策略**，通过时间模拟，可以算出任务在给定时间段的调度计划。
  * 时间模拟的方法，待补充
* 其他待补充

#### 调度计划修改
* 待补充（反向crond？）

## 任务重跑
任务重跑，实质上是历史task的重跑。可以通过task的调度时间来判断。

* Task重跑，可以指定某个task重跑，也可以指定某一区间内的task重跑。
  * 根据条件通过搜索task历史执行记录来获得重跑的task列表。
* 支持后续依赖任务重跑。
  * 根据最新的依赖来重跑任务。
  * 依据历史的依赖来重跑任务。
* 其他待补充












